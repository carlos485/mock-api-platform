---
import Layout from '@/layouts/Layout.astro';
import AuthGuard from '@/components/AuthGuard.astro';
---

<Layout>
  <AuthGuard>
    <div class="min-h-screen bg-base-200">
      <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
          <a class="btn btn-ghost text-xl">Mock API Platform</a>
        </div>
        <div class="flex-none">
          <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
              <div class="bg-neutral text-neutral-content rounded-full w-10">
                <span id="user-avatar">U</span>
              </div>
            </div>
            <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
              <li><a id="profile-link">Perfil</a></li>
              <li><a id="logout-btn">Cerrar Sesión</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="container mx-auto p-8">
        <div class="hero bg-base-100 rounded-lg shadow-xl">
          <div class="hero-content text-center">
            <div class="max-w-md">
              <h1 class="text-5xl font-bold">Bienvenido!</h1>
              <p class="py-6" id="welcome-message">Estás autenticado correctamente.</p>
              <div class="stats shadow">
                <div class="stat">
                  <div class="stat-title">Email</div>
                  <div class="stat-value text-sm" id="user-email">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </AuthGuard>
</Layout>

<script>
  import { authStore } from '@/lib/stores/auth.store';
  import { AuthService } from '@/lib/services/auth.service';

  const logoutBtn = document.getElementById('logout-btn');
  const userEmail = document.getElementById('user-email');
  const userAvatar = document.getElementById('user-avatar');
  const welcomeMessage = document.getElementById('welcome-message');

  // Subscribe to auth state
  const unsubscribe = authStore.subscribe((state) => {
    if (state.user) {
      if (userEmail) userEmail.textContent = state.user.email || '-';
      if (userAvatar) {
        const initial = state.user.displayName?.[0] || state.user.email?.[0] || 'U';
        userAvatar.textContent = initial.toUpperCase();
      }
      if (welcomeMessage) {
        const name = state.user.displayName || state.user.email;
        welcomeMessage.textContent = `Hola ${name}, estás autenticado correctamente.`;
      }
    }
  });

  // Handle logout
  logoutBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await AuthService.logout();
      window.location.href = '/login';
    } catch (error) {
      console.error('Error logging out:', error);
    }
  });

  // Cleanup
  window.addEventListener('beforeunload', () => {
    unsubscribe();
  });
</script>
